{% extends 'base.html' %}
{% block content %}
<h1 style="margin-top:0; font-size:1.05rem;">Projekt: {{ project.name }}</h1>
<p style="margin-top:-6px; font-size:0.75rem; color:#5a6b7d;">{{ project.description or 'Kein Beschreibungstext' }}</p>
<div class="flex gap" style="align-items:stretch;">
	<!-- Chats (38%) -->
	<div class="card" style="flex-basis:38%; min-width:300px;">
		<div class="card-header">Chats</div>
		<form method="post" action="{{ url_for('chats.create') }}" class="inline" style="margin-bottom:0.4rem;">
			<input type="hidden" name="project_id" value="{{ project.id }}" />
			<input type="text" name="title" placeholder="Neuer Chat" />
			<button class="subtle" type="submit">+</button>
		</form>
			<table class="list" style="margin-top:0;">
				<thead><tr><th>Titel</th><th>Erstellt</th><th>Msgs</th><th style="width:40px;">&nbsp;</th></tr></thead>
			<tbody>
				{% for c in chats %}
						<tr>
							<td onclick="window.location='{{ url_for('chats.view', chat_id=c.id) }}'" style="cursor:pointer;">{{ c.title }}</td>
							<td style="white-space:nowrap;" onclick="window.location='{{ url_for('chats.view', chat_id=c.id) }}'">{{ c.created_at.strftime('%d.%m %H:%M') }}</td>
							<td onclick="window.location='{{ url_for('chats.view', chat_id=c.id) }}'">{{ c.messages.count() }}</td>
							<td style="text-align:right;">
								<form method="post" action="{{ url_for('chats.delete', chat_id=c.id) }}" onsubmit="return confirm('Chat löschen?');">
									<button type="submit" class="outline" style="padding:2px 6px; font-size:0.6rem;">✕</button>
								</form>
							</td>
					</tr>
				{% else %}
						<tr><td colspan="4">Keine Chats</td></tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<!-- Worker (38%) -->
	<div class="card" style="flex-basis:38%; min-width:300px;">
		<div class="card-header">Worker</div>
		<form method="post" action="{{ url_for('workers.create') }}" class="inline" style="margin-bottom:0.4rem;">
			<input type="hidden" name="project_id" value="{{ project.id }}" />
			<input type="text" name="name" placeholder="Neuer Worker" />
			<button class="subtle" type="submit">+</button>
		</form>
			<table class="list" style="margin-top:0;">
				<thead><tr><th>Name</th><th>Erstellt</th><th>Runs</th><th style="width:40px;">&nbsp;</th></tr></thead>
			<tbody>
				{% for w in workers %}
						<tr>
							<td onclick="window.location='{{ url_for('workers.view', worker_id=w.id) }}'" style="cursor:pointer;">{{ w.name }}</td>
							<td style="white-space:nowrap;" onclick="window.location='{{ url_for('workers.view', worker_id=w.id) }}'">{{ w.created_at.strftime('%d.%m %H:%M') }}</td>
							<td onclick="window.location='{{ url_for('workers.view', worker_id=w.id) }}'">{{ w.logs.count() }}</td>
							<td style="text-align:right;">
								<form method="post" action="{{ url_for('workers.delete', worker_id=w.id) }}" onsubmit="return confirm('Worker löschen?');">
									<button type="submit" class="outline" style="padding:2px 6px; font-size:0.6rem;">✕</button>
								</form>
							</td>
					</tr>
				{% else %}
						<tr><td colspan="4">Keine Worker</td></tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<!-- Dateien (24%) -->
	<div class="card" style="flex-basis:24%; min-width:240px; display:flex; flex-direction:column; gap:0.9rem;">
		<div>
			<div class="card-header">Dateien</div>
			<form method="post" action="{{ url_for('projects.update_files', project_id=project.id) }}" class="inline" style="margin-bottom:0.4rem;">
				{% for f in project.files %}
					<input type="hidden" name="file_ids" value="{{ f.id }}" />
				{% endfor %}
				<select name="file_ids" style="min-width:160px;">
					<option value="">-- Datei hinzufügen --</option>
					{% for f in available_files %}
						{% if f not in project.files %}
							<option value="{{ f.id }}">{{ f.filename }}</option>
						{% endif %}
					{% endfor %}
				</select>
				<button class="subtle" type="submit">Speichern</button>
			</form>
			<table class="list" style="margin-top:0;">
				<thead><tr><th>Name</th><th style="width:34px;">&nbsp;</th></tr></thead>
				<tbody>
					{% for f in project.files %}
					<tr>
						<td style="font-size:0.7rem;">{{ f.filename }}</td>
						<td style="text-align:right;">
							<form method="post" action="{{ url_for('projects.update_files', project_id=project.id) }}" onsubmit="return confirm('Datei entfernen?');">
								{% for keep in project.files %}
									{% if keep.id != f.id %}
										<input type="hidden" name="file_ids" value="{{ keep.id }}" />
									{% endif %}
								{% endfor %}
								<button type="submit" class="outline" style="padding:2px 6px; font-size:0.6rem;">✕</button>
							</form>
						</td>
					</tr>
					{% else %}
					<tr><td colspan="2" style="font-size:0.7rem;">Keine Dateien</td></tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div>
			<div class="card-header">Worker Outputs</div>
			<table class="list" style="margin-top:0;">
				<thead><tr><th>Worker</th><th>Dateien</th></tr></thead>
				<tbody>
					{% set any_out = false %}
					{% for w in workers %}
						{% set row_links = [] %}
						{% for log in w.logs.limit(10) %}
							{% if log.output_file_ids %}
								{% set any_out = true %}
								{% set cleaned = log.output_file_ids.replace('[','').replace(']','').replace('"','') %}
								{% for fid in cleaned.split(',') if fid.strip() %}
									{% set fid_trim = fid.strip() %}
									{% set fo = file_map.get(fid_trim) %}
									{% if fo %}
										{% set link = url_for('files.download', file_id=fo.id) %}
										{% set _ = row_links.append('<a href="' ~ link ~ '">' ~ (fo.filename[:14] ~ ("…" if fo.filename|length>14 else "")) ~ '</a>') %}
									{% else %}
										{% set _ = row_links.append(fid_trim[:8] ~ '…') %}
									{% endif %}
								{% endfor %}
							{% endif %}
						{% endfor %}
						{% if row_links %}
						<tr>
							<td style="font-size:0.65rem;">{{ w.name }}</td>
							<td style="font-size:0.6rem;">{{ row_links|join(', ')|safe }}</td>
						</tr>
						{% endif %}
					{% endfor %}
					{% if not any_out %}
						<tr><td colspan="2" style="font-size:0.7rem;">Keine Outputs</td></tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>
</div>
<p style="margin-top:1rem;"><a href="/projects/" style="font-size:0.7rem;">← Zurück</a></p>
{% endblock %}
